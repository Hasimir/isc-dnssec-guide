<section id="recipes-rollovers">
 <title>Rollover Recipes</title>

 <!-- === ZSK Rollover === -->
 <section id="recipes-zsk-rollover">
  <title>ZSK Rollover Recipe</title>

  <para>This recipe covers how to perform a ZSK rollover using what is known as
  the Pre-Publication method. For other ZSK rolling methods, please see <xref
  linkend="zsk-rollover-methods" /> in <xref
  linkend="dnssec-advanced-discussions" />. </para>

  <para>Below is the timeline for a ZSK rollover to occur on January 1st,
  2015:</para>

  <orderedlist>
   <listitem>
    <simpara>December 1st, 2014, a month before rollover</simpara>
    <itemizedlist>
     <listitem>
      <simpara>Generate new ZSK</simpara>
     </listitem>
     <listitem>
      <simpara>Add DNSKEY for new ZSK to zone</simpara>
     </listitem>
    </itemizedlist>
   </listitem>

   <listitem>
    <simpara>January 1st, 2015, day of rollover</simpara>
    <itemizedlist>
     <listitem>
      <simpara>Use existing KSK to sign new ZSK, add new RRSIG for new ZSK to
      the zone</simpara>
     </listitem>
     <listitem>
      <simpara>Start using new ZSK to sign records</simpara>
     </listitem>
     <listitem>
      <simpara>Remove RRSIG for old ZSK from zone</simpara>
     </listitem>
    </itemizedlist>
   </listitem>

   <listitem>
    <simpara>February 1st, 2015</simpara>
    <itemizedlist>
     <listitem>
      <simpara>Remove old ZSK DNSKEY RRset from zone</simpara>
     </listitem>
    </itemizedlist>
   </listitem>
  </orderedlist>

  <para>The current active ZSK has the ID 17694 in this example. For more
  information on key management (such as what inactive date is, and why 30 days
  for example), please see <xref linkend="advanced-discussions-key-management"
  />. </para>

  <!-- === One Month Before ZSK Rollover === -->
  <section id="one-month-before-zsk-rollover">
   <title>One Month Before ZSK Rollover</title>

   <para>On December 1st, 2014, a month before the planned rollover, you should 
   change the parameters on the current key (17694) to become inactive on
   January 1st, 2015, and be deleted from the zone on February 1st, 2015, as
   well as generate a successor key (51623):</para>

   <screen># <userinput>cd /etc/bind/keys/example.com/</userinput>
# <userinput>dnssec-settime -I 20150101 -D 20150201 Kexample.com.+008+17694</userinput>
./Kexample.com.+008+17694.key
./Kexample.com.+008+17694.private
# <userinput>dnssec-keygen -S Kexample.com.+008+17694</userinput>
Generating key pair..++++++ ...........++++++ 
Kexample.com.+008+<userinput>51623</userinput></screen>

   <para>The first command gets us into the key directory <filename>
   /etc/bind/keys/example.com/ </filename>, where keys for <code> example.com
   </code> are stored.</para>

   <para>The second <command>dnssec-settime</command> sets an inactive (-I) date
   of January 1st, 2015, and a deletion (-D) date of February 1st, 2015 for the
   current ZSK (Kexample.com.+008+17694).</para>

   <para>Then the third command <command>dnssec-keygen</command> creates a
   successor key, using the exact same parameters (algorithms, key sizes, etc.)
   as the current ZSK. The new ZSK created in our example is
   Kexample.com.+008+51623. </para>

   <para>Don't forget to make sure the successor keys are readable by
   <command>named</command>.</para>

   <para>You can see in syslog the messages informing you when the next key
   checking event is, and it looks like this:</para>

   <screen>zone example.com/IN (signed): next key event: 01-Dec-2014 00:13:05.385</screen>

   <para>And you can check the publish date of the key by looking at the key
   file:</para>

   <screen># <userinput>cd /etc/bind/keys/example.com</userinput>
# cat Kexample.com.+008+51623.key 
; This is a zone-signing key, keyid 11623, for example.com.
; Created: 20141130160024 (Mon Dec  1 00:00:24 2014)
; <userinput>Publish: 20141202000000 (Tue Dec  2 08:00:00 2014)</userinput>
; Activate: 20150101000000 (Thu Jan  1 08:00:00 2015)
...</screen>

   <para>Since the publish date is set to the morning of December 2nd, the next
   morning you will notice that your zone has gained a new DNSKEY record, but no
   corresponding RRSIG yet. Below is the abbreviated output with shortened DNSKEY
   and RRSIG when querying the authoritative name server, 192.168.1.13:</para>

   <screen>$ <userinput>dig @192.168.1.13 example.com. DNSKEY +dnssec +multiline</userinput>

...
;; ANSWER SECTION:
example.com.		600 IN DNSKEY 257 3 8 (
				AwEAAcWDps...lM3NRn/G/R
				) ; KSK; alg = RSASHA256; key id = 6817
example.com.		600 IN DNSKEY 256 3 8 (
				AwEAAbi6Vo...qBW5+iAqNz
				) ; ZSK; alg = RSASHA256; key id = <userinput>51623</userinput>
example.com.		600 IN DNSKEY 256 3 8 (
				AwEAAcjGaU...0rzuu55If5
				) ; ZSK; alg = RSASHA256; key id = 17694
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150101000000 20141201230000 6817 example.com.
				LAiaJM26T7...FU9syh/TQ= )
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150101000000 20141201230000 17694 example.com.
				HK4EBbbOpj...n5V6nvAkI= )
...</screen>

   <para>These are all the manual tasks you need to perform for a ZSK rollover.
   If you have followed the configuration examples in this guide of using
   <varname>inline-signing</varname> and <varname>auto-dnssec</varname>,
   everything else is automated for you.</para>
  </section>

  <!-- === Day of ZSK Rollover === -->
  <section id="day-of-zsk-rollover">
   <title>Day of ZSK Rollover</title>

   <para>On the actual day of the rollover, although there is technically
   nothing for you to do, you should still keep an eye on the zone to make sure
   new signatures are being generated by new ZSK (51623 in this example). The
   easiest way is to query for the same DNSKEY and signatures like you did a
   month ago:</para>

   <screen>$ <userinput>dig @192.168.1.13 example.com. DNSKEY +multiline +dnssec</userinput>

...
;; ANSWER SECTION:
example.com.		600 IN DNSKEY 257 3 8 (
				AwEAAcWDps...lM3NRn/G/R
				) ; KSK; alg = RSASHA256; key id = 6817
example.com.		600 IN DNSKEY 256 3 8 (
				AwEAAdeCGr...1DnEfX+Xzn
				) ; ZSK; alg = RSASHA256; key id = 51623
example.com.		600 IN DNSKEY 256 3 8 (
				AwEAAcjGaU...0rzuu55If5
				) ; ZSK; alg = RSASHA256; key id = 17694
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150131000000 20141231230000 6817 example.com.
				KHY8P0zE21...Y3szrmjAM= )
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150131000000 20141231230000 <userinput>51623</userinput> example.com.
				G2g3crN17h...Oe4gw6gH8= )</screen>

   <para>As you can see, the signature generated by the old ZSK (17694)
   disappeared, replaced by a new signature generated from the new ZSK
   (51623).</para>

   <note>
    <title>Life Time of the Signatures</title>
    <para>Not all signatures will disappear magically on the same day,
    depending on when each one is generated. Worst case scenario is that a new
    signature could have been signed by the old ZSK (17695) moments before it
    was deactivated, thus the signature could live for almost 30 more days, all
    the way up to right before February 1st. </para>

    <para>This is why it is important that you should keep the old ZSK in the
    zone for a little bit longer and not delete it right away. </para> 

   </note>
  </section>

  <!-- === One Month After ZSK Rollover === -->
  <section id="one-month-after-zsk-rollover">
   <title>One Month After ZSK Rollover</title>
   <para>Again, technically there should be nothing you need to do on this day,
   but it doesn't hurt to verify that the old ZSK (17694) is now completely
   gone from your zone. <command>named</command> will not touch
   <filename>Kexample.com.+008+17694.private</filename> and
   <filename>Kexample.com.+008+17694.key</filename> on your file system.
   Running the same <command>dig</command> command for DNSKEY should
   suffice:</para>

   <screen>$ <userinput>dig @192.168.1.13 example.com. DNSKEY +multiline +dnssec</userinput>

...
;; ANSWER SECTION:
example.com.		600 IN DNSKEY 257 3 8 (
				AwEAAcWDps...lM3NRn/G/R
				) ; KSK; alg = RSASHA256; key id = 6817
example.com.		600 IN DNSKEY 256 3 8 (
				AwEAAdeCGr...1DnEfX+Xzn
				) ; ZSK; alg = RSASHA256; key id = 51623
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150131000000 20141231230000 6817 example.com.
				KHY8P0zE21...Y3szrmjAM= )
example.com.		600 IN RRSIG DNSKEY 8 2 600 (
				20150131000000 20141231230000 51623 example.com.
				G2g3crN17h...Oe4gw6gH8= )
...</screen>

   <para>Congratulations, the ZSK rollover is complete!</para>

  </section>
 </section>


 <!-- === KSK Rollover === -->
 <section id="recipes-ksk-rollover">
  <title>KSK Rollover Recipe</title>
 </section>
</section>
